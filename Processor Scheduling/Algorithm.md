# 处理机调度

## 处理机调度概念

15.1 4:39 内核运行调度程序的条件重复

- 进程切换：CPU 资源的当前占用者切换
  - 保存当前进程在 PCB 中的执行上下文（CPU 状态）
  - 恢复下一个进程的执行上下文
- 处理机调度
  - 从就绪队列中**挑选**下一个占用 CPU 的**进程**
  - if 多 CPU，从多个可用 CPU 中挑选就绪进程可使用的 CPU 资源
- 调度程序：挑选就绪进程的内核函数
  - 策略
    - 依据什么原则挑选进程/线程
  - 时机
    - 执行调度程序的条件
      1. 进程： 运行 -> 等待
      2. 进程被终结
    - 非抢占系统
      当前进程主动放弃 CPU
    - 抢占
      1. 中断请求被服务例程响应完成
      2. 进程被抢占
         - 进程时间片用完 （时钟中断
         - 某进程从等待切换到就绪，更急迫

## 处理机资源的使用模式

- 进程在 CPU 计算和 I/O 操作间交替
  - 每次调度决定在下一个 CPU 计算时将哪个工作交给 CPU
  - 在时间片机制下，进程可能在结束当前 CPU 计算前被迫放弃

## 调度准则

- 调度策略
  - 挑选哪一个
  - 用什么准则
- 调度算法指标
  - CPU 的使用率
    - CPU 处于忙状态的时间百分比
  - 吞吐量
    - 单位时间进程数量
  - 周转时间
    - 初始化到结束的总时间
  - 等待时间
    - 进程在就绪队列中的总时间
  - 响应时间
    - 提交请求到产生响应所花费的时间
- 要求
  - 响应时间目标
    - 低响应时间
    - 波动少，方差小
  - 吞吐量目标
    - 减少开销
    - 系统资源的高效利用
    - 减少等待时间
  - 公平性目标
    - 每个进程占用相同 CPU 时间和等待时间

## 调度算法

### 先来先服务

- FCFS
  - 平均等待时间波动大
  - I/O CPU 利用率低
    - CPU 密集型

### 短进程优先

- pros
  - 具有**最优**平均周转时间
- cons

  - 可能导致饥饿
  - 连续短进程使长进程无法获得 CPU 资源
  - 需要预知

    - 询问用户
      1. 用户欺骗，时间短 -> 即使时间长也执行
      2. 用户傻，不知道
    - 执行时间预估

      - 过去预测未来

        ```C
        Tn+1=a*Tn+(1-a)*Tn  // Tn 第n次执行时间，0<=a<=1
        ```

- SPN
  - 选择执行时间最短进程占用 CPU
    - 就绪队列按**预期**执行时间来排序
- SJF
  - 短**剩余**时间优先

### 最高响应比优先

HRRN

- 选择就绪队列中响应比 R 最高的进程
  - R=(w+s)/s w 等待时间，s 预计执行时间

### 时间片轮转

RR

- 时间片
  - 分配处理机资源的基本时间单元
  - 1~100ms
    - 太大退化为 FCFS
    - 太小产生大量上下文切换，开销大，影响系统吞吐量

### 多级队列

就绪队列被划分成多个独立的子队列
每个队列拥有自己的调度
队列之间有调度

- 多级反馈队列 MFQ
- 进程可在不同队列间移动
  
### 公平共享调度

- FSS
